import{s as g}from"./index-Dxh3r0nY.js";const P={"1d":1,"7d":7,"30d":30,"12m":365};function T(r){const i=P[r]??30,s=new Date;s.setHours(0,0,0,0),s.setDate(s.getDate()-(i-1));const t=new Date;t.setHours(23,59,59,999);const e=new Date(s);e.setDate(e.getDate()-1),e.setHours(23,59,59,999);const n=new Date(e);return n.setDate(n.getDate()-(i-1)),n.setHours(0,0,0,0),{since:s,until:t,previousSince:n,previousUntil:e}}function v(r){return r.reduce((i,s)=>(i.clicks+=Number(s.clicks||0),i.earnings+=Number(s.earnings||0),i.paid_clicks+=Number(s.paid_clicks||0),i),{clicks:0,earnings:0,paid_clicks:0})}function f(r,i){return i===0?r>0?100:null:(r-i)/Math.abs(i)*100}function b(r){return r.toLocaleDateString("es-ES",{day:"numeric",month:"short"})}function N(r,i,s){const t=new Map;r.forEach(a=>t.set(a.day,a));const e=new Date(i),n=[];for(;e<=s;){const a=e.toISOString().slice(0,10),k=t.get(a);n.push(k||{day:a,clicks:0,earnings:0,paid_clicks:0}),e.setDate(e.getDate()+1)}return n}function H(r,i,s,t=14){if(!r.length)return Array(t).fill(0);const n=(s.getTime()-i.getTime())/t,a=Array(t).fill(0);return r.forEach(k=>{const p=new Date(k.created_at).getTime(),_=Math.min(t-1,Math.max(0,Math.floor((p-i.getTime())/n)));a[_]+=Number(k.earned_amount||0)}),a}function A(r,i,s){const t={};return r.forEach(e=>{const n=new Date(e.created_at).toISOString().slice(0,10);t[n]||(t[n]={day:n,clicks:0,earnings:0,paid_clicks:0}),t[n].clicks+=1,t[n].earnings+=Number(e.earned_amount||0),t[n].paid_clicks+=e.is_paid?1:0}),Object.values(t).filter(e=>{const n=new Date(e.day);return n>=i&&n<=s}).sort((e,n)=>e.day<n.day?-1:1)}function j(r){const i=new Map;r.forEach(t=>{const e=(t.country||"Unknown").toUpperCase();i.set(e,(i.get(e)||0)+1)});const s=Array.from(i.values()).reduce((t,e)=>t+e,0);return Array.from(i.entries()).map(([t,e])=>({country:t,value:e,percent:s?e/s*100:0})).sort((t,e)=>e.value-t.value)}function B(r){const i=new Map;r.forEach(t=>{const e=t.device||"Unknown";i.set(e,(i.get(e)||0)+1)});const s=Array.from(i.values()).reduce((t,e)=>t+e,0);return Array.from(i.entries()).map(([t,e])=>({device:t,value:e,percent:s?e/s*100:0})).sort((t,e)=>e.value-t.value)}function F(r,i,s){const t=new Map;return r.forEach(n=>{if(!n.link_id)return;t.has(n.link_id)||t.set(n.link_id,{slug:n.link_slug,title:n.link_title,earnings:0,clicks:0,paid:0,evs:[]});const a=t.get(n.link_id);a.earnings+=Number(n.earned_amount||0),a.clicks+=1,a.paid+=n.is_paid?1:0,a.evs.push(n)}),{topLinks:Array.from(t.entries()).map(([n,a])=>({id:n,slug:a.slug,title:a.title,earnings:a.earnings,clicks:a.clicks,ctr:a.clicks>0?a.paid/a.clicks:0,sparkline:H(a.evs,i,s,14)})).sort((n,a)=>a.earnings-n.earnings).slice(0,5)}}const K={async getDashboardData(r="30d"){const{data:i}=await g.auth.getUser(),s=i==null?void 0:i.user;if(!s)return null;const{since:t,until:e,previousSince:n,previousUntil:a}=T(r),[k,p,_,I,O]=await Promise.all([g.from("analytics_events_daily").select("day, clicks, earnings, paid_clicks").eq("owner_id",s.id).gte("day",t.toISOString()).lt("day",e.toISOString()).order("day",{ascending:!0}),g.from("analytics_events_daily").select("day, clicks, earnings, paid_clicks").eq("owner_id",s.id).gte("day",n.toISOString()).lt("day",a.toISOString()).order("day",{ascending:!0}),g.from("links").select("id",{count:"exact",head:!0}).eq("user_id",s.id).eq("is_active",!0),g.from("analytics_events").select("created_at, earned_amount, is_paid, link_id, link_slug, link_title, country, device").eq("owner_id",s.id).gte("created_at",t.toISOString()).lt("created_at",e.toISOString()).order("created_at",{ascending:!1}).limit(5e3),g.from("links").select("id, slug, title, earnings, views").eq("user_id",s.id)]),w=k.data||[],D=p.data||[];let o=I.data||[];const m=O.data||[];if((!o||o.length===0)&&m.length>0){const c=m.map(C=>C.id),d=await g.from("click_events").select("created_at, earned_amount, is_paid, link_id, country, device").in("link_id",c).gte("created_at",t.toISOString()).lt("created_at",e.toISOString()).order("created_at",{ascending:!1}).limit(5e3);!d.error&&d.data&&(o=d.data)}const y=N(w.length?w:A(o,t,e),t,e),M=N(D.length?D:A(o,n,a),n,a),l=v(y),u=v(M);(!o||o.length===0)&&m.length>0&&(l.earnings=m.reduce((c,d)=>c+(d.earnings||0),0),l.clicks=m.reduce((c,d)=>c+(d.views||0),0),l.paid_clicks=0);const S=l.clicks>0?l.paid_clicks/l.clicks:0,h=u.clicks>0?u.paid_clicks/u.clicks:0,R={earnings:l.earnings,clicks:l.clicks,conversionRate:S,activeLinks:_.count||0,deltas:{earnings:f(l.earnings,u.earnings),clicks:f(l.clicks,u.clicks),conversionRate:f(S,h),activeLinks:null},previous:{earnings:u.earnings,clicks:u.clicks,conversionRate:h}},E=j(o),L=B(o),{topLinks:U}=o.length?F(o,t,e):{topLinks:m.map(c=>({id:c.id,slug:c.slug,title:c.title,earnings:c.earnings||0,clicks:c.views||0,ctr:0,sparkline:Array(14).fill(0)})).sort((c,d)=>d.earnings-c.earnings).slice(0,5)},q=y.map(c=>({date:b(new Date(c.day)),earnings:Number(c.earnings||0),clicks:Number(c.clicks||0)})),x=y.map(c=>({date:b(new Date(c.day)),clicks:Number(c.clicks||0)}));return{range:r,summary:R,timeseries:q,clicksByDay:x,countries:E,devices:L,topLinks:U,lastUpdated:new Date().toISOString()}}};export{K as A};
